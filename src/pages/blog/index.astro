---
import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import TagFilter from '../../components/ui/TagFilter.astro';
import { formatDate, getUniqueTags } from '../../lib/utils';

const posts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const tags = getUniqueTags(posts);
---

<Base title="Blog | Todd Thomas" description="Thoughts on platform engineering, leadership, and building teams.">
  <Header />
  <main class="flex-1">
    <section class="container py-16 md:py-20">
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-3xl font-heading font-semibold md:text-4xl">
            Blog
          </h1>
          <p class="mt-2 text-text-secondary">
            Thoughts on engineering and leadership.
          </p>
        </div>
      </div>

      {tags.length > 0 && (
        <div class="mt-8">
          <TagFilter tags={tags} basePath="/blog" />
        </div>
      )}

      <div class="mt-8 divide-y divide-border-subtle">
        {sortedPosts.map((post) => (
          <a
            href={`/blog/${post.id}`}
            class="group flex flex-col gap-2 py-6 first:pt-0 last:pb-0 md:flex-row md:items-center md:justify-between md:gap-4"
            data-tags={post.data.tags.join(' ').toLowerCase()}
          >
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:gap-4">
              <span class="font-mono text-sm text-text-muted shrink-0">
                {formatDate(post.data.date)}
              </span>
              <div class="flex items-center gap-3">
                <span class="rounded-full bg-bg-tertiary px-2.5 py-0.5 font-mono text-xs text-text-secondary">
                  {post.data.tags[0]}
                </span>
                <span class="font-medium group-hover:text-accent-primary transition-colors">
                  {post.data.title}
                </span>
              </div>
            </div>
            <span class="hidden text-text-muted group-hover:text-accent-primary transition-colors md:block">
              &rarr;
            </span>
          </a>
        ))}
      </div>

      {sortedPosts.length === 0 && (
        <p class="mt-8 text-text-muted">No posts yet. Check back soon.</p>
      )}
    </section>
  </main>
  <Footer />
</Base>
